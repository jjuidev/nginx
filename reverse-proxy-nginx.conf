# ============================================================
# UPSTREAM: Định nghĩa nhóm backend servers để load balance
# ============================================================

upstream backend_cluster {
  # Thuật toán load balancing (mặc định: round-robin - phân phối đều)
  # Bỏ comment để dùng thuật toán khác:
  # least_conn;  # Gửi request đến server có ít connections nhất
  # ip_hash;     # Sticky session - cố định client IP với 1 backend

  # --- Backend servers với health check ---
  # max_fails: Số lần fail tối đa trước khi đánh dấu backend DOWN (default: 1)
  # fail_timeout: Thời gian backend bị DOWN sau khi đạt max_fails (default: 10s)
  #
  # Cơ chế: Request fail → thử backend khác ngay → Sau 3 lần fail → DOWN 30s
  server localhost:8080 max_fails=3 fail_timeout=30s;
  server localhost:8081 max_fails=3 fail_timeout=30s;
  server localhost:8082 max_fails=3 fail_timeout=30s;

  # --- Upstream keepalive: Connection pool NGINX → BACKEND ---
  # keepalive: Số idle connections tái sử dụng (default: 0 - TẮT keepalive!)
  # BẮT BUỘC set > 0 để tăng performance, giảm latency
  keepalive 32;
}

# ============================================================
# SERVER: Cấu hình reverse proxy
# ============================================================

server {
  listen 80;
  server_name example.com;

  location / {
    # Proxy tất cả requests đến upstream cluster
    proxy_pass http://backend_cluster;

    # --- Proxy headers: Forward thông tin gốc của client sang backend ---
    # Host: Domain gốc client truy cập (default: $proxy_host - sai!)
    # → Backend cần để: redirects, CORS, virtual hosting
    proxy_set_header Host $host;

    # X-Real-IP: IP thật của client (default: không có)
    # → Backend cần để: logging, rate limiting, security blocking
    proxy_set_header X-Real-IP $remote_addr;

    # X-Forwarded-For: Chuỗi tất cả IPs đã đi qua (default: không có)
    # → Backend cần để: trace qua nhiều proxies (CDN, load balancer)
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # X-Forwarded-Proto: Protocol gốc http/https (default: không có)
    # → Backend cần để: redirects đúng protocol, secure cookies
    proxy_set_header X-Forwarded-Proto $scheme;

    # --- Upstream keepalive settings ---
    # proxy_http_version: HTTP version cho upstream (default: 1.0)
    # BẮT BUỘC set 1.1 để dùng keepalive với upstream
    proxy_http_version 1.1;

    # Connection: Clear header Connection (default: "close")
    # BẮT BUỘC set "" để keepalive upstream hoạt động
    proxy_set_header Connection "";

    # --- Auto-retry khi backend fail ---
    # proxy_next_upstream: Điều kiện để thử backend khác (default: error timeout)
    # Thêm http_502/503/504 để retry khi backend trả về error codes
    proxy_next_upstream error timeout http_502 http_503 http_504;
  }
}